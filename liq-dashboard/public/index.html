<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Equity Perp Liquidity Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #07090b;
    --panel: #0c1014;
    --panel2: #101519;
    --border: #182028;
    --border2: #222e3a;
    --text: #c0d0de;
    --muted: #3d5468;
    --muted2: #5a7080;
    --accent: #00d4aa;
    --accent2: #2196f3;
    --green: #00e676;
    --red: #ff4560;
    --warn: #ffd600;
    --hl-color: #a78bfa;
    --li-color: #38bdf8;
    --ord-color: #fb923c;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    min-height: 100vh;
  }
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,0,0,0.04) 3px, rgba(0,0,0,0.04) 4px);
    pointer-events: none;
    z-index: 9999;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 24px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(90deg, rgba(0,212,170,0.06) 0%, transparent 50%);
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(8px);
  }
  .logo {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 800;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent);
  }
  .logo em { color: var(--muted2); font-style: normal; font-weight: 400; font-size: 11px; margin-left: 10px; letter-spacing: 0.06em; }
  .header-meta {
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 10px;
    color: var(--muted2);
    letter-spacing: 0.08em;
  }
  .live-dot {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 10px var(--green);
    margin-right: 5px;
    animation: blink 1.8s ease-in-out infinite;
  }
  .live-dot.off { background: var(--muted); box-shadow: none; animation: none; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
  #ts { color: var(--accent); }
  .toolbar {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    padding: 10px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--panel);
  }
  .ctrl-group { display: flex; align-items: center; gap: 8px; }
  .ctrl-label { font-size: 9px; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; }
  .chip {
    padding: 3px 10px;
    border: 1px solid var(--border2);
    border-radius: 2px;
    color: var(--muted2);
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    cursor: pointer;
    background: transparent;
    transition: all 0.12s;
    letter-spacing: 0.04em;
  }
  .chip:hover { border-color: var(--muted2); color: var(--text); }
  .chip.on { border-color: var(--accent); color: var(--accent); background: rgba(0,212,170,0.08); }
  .chip.size-on { border-color: var(--accent2); color: var(--accent2); background: rgba(33,150,243,0.08); }
  .sep { width: 1px; height: 18px; background: var(--border2); }
  .refresh-btn {
    margin-left: auto;
    padding: 4px 12px;
    border: 1px solid var(--border2);
    border-radius: 2px;
    background: transparent;
    color: var(--muted2);
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    cursor: pointer;
    letter-spacing: 0.08em;
    transition: all 0.15s;
  }
  .refresh-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,212,170,0.06); }
  .refresh-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  select.ctrl-sel {
    background: transparent;
    border: 1px solid var(--border2);
    color: var(--muted2);
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  select.ctrl-sel option { background: #101519; color: var(--text); }
  select.ctrl-sel:focus { border-color: var(--accent); color: var(--accent); }
  main { padding: 20px 24px; }
  .venue-bar { display: flex; gap: 6px; margin-bottom: 18px; flex-wrap: wrap; }
  .venue-pill {
    display: flex; align-items: center; gap: 7px;
    padding: 5px 14px; border-radius: 2px;
    border: 1px solid var(--border2);
    font-size: 10px; letter-spacing: 0.06em; text-transform: uppercase;
  }
  .venue-pill .dot { width: 7px; height: 7px; border-radius: 50%; }
  .hl-pill { border-color: rgba(167,139,250,0.3); color: var(--hl-color); }
  .hl-pill .dot { background: var(--hl-color); box-shadow: 0 0 6px var(--hl-color); }
  .li-pill { border-color: rgba(56,189,248,0.3); color: var(--li-color); }
  .li-pill .dot { background: var(--li-color); box-shadow: 0 0 6px var(--li-color); }
  .ord-pill { border-color: rgba(251,146,60,0.3); color: var(--ord-color); }
  .ord-pill .dot { background: var(--ord-color); box-shadow: 0 0 6px var(--ord-color); }
  .venue-pill .status-tag {
    font-size: 8px; color: var(--muted);
    border: 1px solid var(--border2);
    padding: 1px 5px; border-radius: 1px; letter-spacing: 0.06em;
  }
  .venue-pill .status-tag.ok  { color: var(--green); border-color: rgba(0,230,118,0.3); }
  .venue-pill .status-tag.err { color: var(--red);   border-color: rgba(255,69,96,0.3); }
  .venue-pill .status-tag.sim { color: var(--warn);  border-color: rgba(255,214,0,0.3); }
  .summary-bar { display: flex; gap: 1px; margin-bottom: 20px; flex-wrap: wrap; }
  .sum-card {
    flex: 1; min-width: 140px;
    background: var(--panel); border: 1px solid var(--border);
    padding: 12px 16px; border-radius: 2px;
  }
  .sum-label { font-size: 9px; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 4px; }
  .sum-val { font-size: 18px; font-family: 'Syne', sans-serif; font-weight: 700; color: var(--text); }
  .sum-sub { font-size: 9px; color: var(--muted2); margin-top: 2px; }
  .section-title {
    font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 600;
    letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted2);
    margin-bottom: 8px; border-left: 2px solid var(--accent); padding-left: 8px;
  }
  .table-wrap { border: 1px solid var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 24px; }
  .table-container { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 700px; }
  thead tr { background: var(--panel2); border-bottom: 1px solid var(--border2); }
  th {
    padding: 8px 12px; text-align: left; color: var(--muted2);
    font-size: 9px; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; white-space: nowrap;
  }
  th.right { text-align: right; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:hover { background: rgba(255,255,255,0.015); }
  td { padding: 9px 12px; white-space: nowrap; vertical-align: middle; }
  td.right { text-align: right; }
  .ticker { font-family: 'Syne', sans-serif; font-weight: 600; font-size: 13px; color: #e0eeff; letter-spacing: 0.04em; }
  .venue-badge { font-size: 9px; letter-spacing: 0.06em; text-transform: uppercase; padding: 2px 6px; border-radius: 2px; font-weight: 600; }
  .v-hl  { color: var(--hl-color);  background: rgba(167,139,250,0.1); border: 1px solid rgba(167,139,250,0.2); }
  .v-li  { color: var(--li-color);  background: rgba(56,189,248,0.1);  border: 1px solid rgba(56,189,248,0.2); }
  .v-ord { color: var(--ord-color); background: rgba(251,146,60,0.1);  border: 1px solid rgba(251,146,60,0.2); }
  .mid-price { color: var(--text); font-size: 12px; }
  .slip-cell { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
  .slip-val { font-size: 11px; font-weight: 500; }
  .slip-bar-wrap { width: 50px; height: 3px; background: var(--border2); border-radius: 2px; overflow: hidden; }
  .slip-bar { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
  .slip-na { color: var(--muted); font-size: 10px; }
  .s0 { color: #00e676; } .s1 { color: #80ed99; } .s2 { color: var(--warn); } .s3 { color: #ff9800; } .s4 { color: var(--red); }
  .bar-s0 { background: #00e676; } .bar-s1 { background: #80ed99; } .bar-s2 { background: var(--warn); } .bar-s3 { background: #ff9800; } .bar-s4 { background: var(--red); }
  .spread-cell { color: var(--muted2); font-size: 10px; }
  .best-badge {
    font-size: 8px; padding: 1px 4px; border-radius: 1px;
    color: var(--accent); border: 1px solid rgba(0,212,170,0.35);
    background: rgba(0,212,170,0.07); letter-spacing: 0.04em;
    margin-left: 4px; vertical-align: middle;
  }
  .loading-row td { text-align: center; padding: 50px; color: var(--muted2); font-size: 11px; letter-spacing: 0.08em; }
  .spinner {
    display: inline-block; width: 12px; height: 12px;
    border: 1.5px solid var(--border2); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.7s linear infinite;
    vertical-align: middle; margin-right: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .notice { font-size: 9px; color: var(--muted); letter-spacing: 0.06em; padding: 6px 0 20px; line-height: 1.6; }
  .sim-notice {
    display: inline-block; background: rgba(255,214,0,0.08);
    border: 1px solid rgba(255,214,0,0.25); color: var(--warn);
    font-size: 9px; padding: 6px 14px; border-radius: 2px;
    letter-spacing: 0.06em; margin-bottom: 14px;
  }
</style>
</head>
<body>

<header>
  <div class="logo">LiqDepth <em>/ Equity Perp Monitor</em></div>
  <div class="header-meta">
    <span><span class="live-dot off" id="liveDot"></span>LIVE</span>
    <span>UPDATED <span id="ts">—</span></span>
    <span id="countdown" style="color:var(--muted)">—</span>
  </div>
</header>

<div class="toolbar">
  <div class="ctrl-group">
    <span class="ctrl-label">Venue</span>
    <button class="chip on" data-venue="hl">Hyperliquid</button>
    <button class="chip on" data-venue="li">Lighter</button>
    <button class="chip on" data-venue="ord">Orderly</button>
  </div>
  <div class="sep"></div>
  <div class="ctrl-group">
    <span class="ctrl-label">Trade Size</span>
    <button class="chip size-on" data-size="1000">$1K</button>
    <button class="chip size-on" data-size="5000">$5K</button>
    <button class="chip size-on" data-size="10000">$10K</button>
    <button class="chip size-on" data-size="25000">$25K</button>
    <button class="chip size-on" data-size="50000">$50K</button>
  </div>
  <div class="sep"></div>
  <div class="ctrl-group">
    <span class="ctrl-label">Auto-refresh</span>
    <select class="ctrl-sel" id="intervalSel">
      <option value="10000">10s</option>
      <option value="15000" selected>15s</option>
      <option value="30000">30s</option>
      <option value="60000">60s</option>
    </select>
  </div>
  <button class="refresh-btn" id="refreshBtn">↻ REFRESH</button>
</div>

<main>
  <div class="venue-bar">
    <div class="venue-pill hl-pill"><div class="dot"></div>Hyperliquid HIP-3<span class="status-tag" id="status-hl">LOADING</span></div>
    <div class="venue-pill li-pill"><div class="dot"></div>Lighter<span class="status-tag" id="status-li">LOADING</span></div>
    <div class="venue-pill ord-pill"><div class="dot"></div>Orderly<span class="status-tag" id="status-ord">LOADING</span></div>
  </div>

  <div id="simNotice" class="sim-notice" style="display:none">
    ⚠ One or more venues returned no data. Showing simulated order book data for those venues. Ensure you are running via Vercel with the proxy API routes active.
  </div>

  <div id="summaryBar" class="summary-bar" style="display:none">
    <div class="sum-card">
      <div class="sum-label">Assets Tracked</div>
      <div class="sum-val" id="sumAssets">—</div>
      <div class="sum-sub">equity perp markets</div>
    </div>
    <div class="sum-card">
      <div class="sum-label">Best Venue ($10K)</div>
      <div class="sum-val" id="sumBest">—</div>
      <div class="sum-sub">lowest avg slippage</div>
    </div>
    <div class="sum-card">
      <div class="sum-label">Deepest Book ($50K)</div>
      <div class="sum-val" id="sumDeepest">—</div>
      <div class="sum-sub">least slippage at size</div>
    </div>
    <div class="sum-card">
      <div class="sum-label">Fetch Time</div>
      <div class="sum-val" id="sumCycle">—</div>
      <div class="sum-sub">last cycle</div>
    </div>
  </div>

  <div class="section-title">Liquidity Depth — Slippage by Trade Size (Market Buy)</div>
  <div class="table-wrap">
    <div class="table-container">
      <table id="mainTable">
        <thead>
          <tr id="theadRow">
            <th>Asset</th><th>Venue</th><th class="right">Mid Price</th><th class="right">Spread</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr class="loading-row"><td colspan="10"><span class="spinner"></span>FETCHING ORDER BOOKS…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="notice">
    Slippage = (effective avg fill price − mid price) / mid price × 100, simulated market buy walking the ask side.<br>
    <strong>BEST</strong> = lowest slippage for that asset + size across visible venues. Proxied via Vercel serverless functions — all venues return live data.
  </div>
</main>

<script>
const ALL_SIZES = [1000, 5000, 10000, 25000, 50000];
const EQUITY_TICKERS = ['AAPL','TSLA','NVDA','AMZN','MSFT','GOOGL','META','SPY','QQQ','COIN'];

// When running on Vercel, use relative proxy paths.
// When opening as a local file, fall back to direct (may hit CORS).
const IS_VERCEL = location.hostname !== 'localhost' && location.protocol !== 'file:';
const PROXY = {
  hl:  IS_VERCEL ? '/api/hyperliquid' : 'https://api.hyperliquid.xyz/info',
  li:  IS_VERCEL ? '/api/lighter'     : 'https://mainnet.zklighter.elliot.ai/api/v1',
  ord: IS_VERCEL ? '/api/orderly'     : 'https://api-evm.orderly.network/v1',
};

let state = {
  activeVenues: new Set(['hl','li','ord']),
  activeSizes: new Set(ALL_SIZES),
  data: [],
  refreshInterval: 15000,
  intervalHandle: null,
  countdownHandle: null,
  countdownSec: 15,
  simVenues: new Set(),
};

function computeSlippage(asks, mid, notional) {
  if (!asks?.length || !mid) return null;
  let remaining = notional, totalCost = 0, totalQty = 0;
  for (const lvl of asks) {
    if (remaining <= 0) break;
    const {px, sz} = lvl;
    const lvlNot = px * sz;
    if (lvlNot >= remaining) { totalQty += remaining/px; totalCost += remaining; remaining = 0; }
    else { totalQty += sz; totalCost += lvlNot; remaining -= lvlNot; }
  }
  if (!totalQty || remaining > 0) return null;
  return ((totalCost/totalQty) - mid) / mid * 100;
}

// ── Hyperliquid (via proxy) ───────────────────────────────────────────────────
async function fetchHL() {
  const SKIP = new Set(['BTC','ETH','SOL','AVAX','BNB','LINK','ARB','OP','DOGE','XRP','ADA','DOT','MATIC','LTC','BCH','UNI','AAVE','CRV','MKR','COMP','FTM','APE','SUI','TIA','INJ','IMX','PYTH','JTO','WIF','ENA','TAO','ORDI','ZK','ZRO']);
  const metaR = await fetch(PROXY.hl, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type:'metaAndAssetCtxs'})
  });
  const [meta, ctxs] = await metaR.json();
  const universe = meta.universe;
  const equities = universe.filter(a => !SKIP.has(a.name) && (EQUITY_TICKERS.includes(a.name) || /^[A-Z]{1,5}$/.test(a.name)));

  const results = [];
  await Promise.allSettled(equities.slice(0,15).map(async asset => {
    const idx = universe.indexOf(asset);
    const ctx = ctxs[idx];
    if (!ctx?.midPx) return;
    const mid = +ctx.midPx;
    try {
      const br = await fetch(PROXY.hl, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({type:'l2Book', coin: asset.name})
      });
      const book = await br.json();
      const bids = (book.levels[0]||[]).map(l=>({px:+l.px,sz:+l.sz}));
      const asks = (book.levels[1]||[]).map(l=>({px:+l.px,sz:+l.sz}));
      if (!asks.length) return;
      const spread = bids.length ? ((asks[0].px - bids[0].px)/mid)*100 : null;
      const slippages = {};
      ALL_SIZES.forEach(sz => { slippages[sz] = computeSlippage(asks, mid, sz); });
      results.push({ticker: asset.name, venue:'hl', mid, spread, slippages});
    } catch(e) {}
  }));
  return results;
}

// ── Lighter (via proxy) ───────────────────────────────────────────────────────
async function fetchLighter() {
  const results = [];
  const base = PROXY.li;
  try {
    const r = await fetch(IS_VERCEL ? `${base}?path=orderbooks` : `${base}/orderbooks`);
    if (!r.ok) throw new Error('no data');
    const d = await r.json();
    const markets = d.order_books || d.orderbooks || d.markets || d.data || [];
    for (const mkt of markets) {
      const sym = (mkt.symbol||mkt.ticker||'').toUpperCase();
      if (!EQUITY_TICKERS.some(t=>sym.includes(t))) continue;
      const ticker = sym.replace(/-PERP|-USD[CT]?/g,'');
      const bids = (mkt.bids||[]).map(b=>Array.isArray(b)?{px:+b[0],sz:+b[1]}:{px:+(b.price||b.px),sz:+(b.size||b.sz)});
      const asks = (mkt.asks||[]).map(a=>Array.isArray(a)?{px:+a[0],sz:+a[1]}:{px:+(a.price||a.px),sz:+(a.size||a.sz)});
      if (!bids.length||!asks.length) continue;
      const mid = (bids[0].px+asks[0].px)/2;
      const spread = ((asks[0].px-bids[0].px)/mid)*100;
      const slippages = {};
      ALL_SIZES.forEach(sz=>{slippages[sz]=computeSlippage(asks,mid,sz);});
      results.push({ticker, venue:'li', mid, spread, slippages});
    }
  } catch(e) {
    // per-ticker fallback
    for (const t of EQUITY_TICKERS.slice(0,6)) {
      try {
        const url = IS_VERCEL ? `${base}?path=orderbook&symbol=${t}-PERP` : `${base}/orderbook?symbol=${t}-PERP`;
        const r = await fetch(url);
        if (!r.ok) continue;
        const d = await r.json();
        const bids=(d.bids||[]).map(b=>({px:+b[0],sz:+b[1]}));
        const asks=(d.asks||[]).map(a=>({px:+a[0],sz:+a[1]}));
        if (!bids.length||!asks.length) continue;
        const mid=(bids[0].px+asks[0].px)/2;
        const spread=((asks[0].px-bids[0].px)/mid)*100;
        const slippages={};
        ALL_SIZES.forEach(sz=>{slippages[sz]=computeSlippage(asks,mid,sz);});
        results.push({ticker:t, venue:'li', mid, spread, slippages});
      } catch(e2) {}
    }
  }
  return results;
}

// ── Orderly (via proxy) ───────────────────────────────────────────────────────
async function fetchOrderly() {
  const results = [];
  const base = PROXY.ord;
  try {
    const infoUrl = IS_VERCEL ? `${base}?path=public/info` : `${base}/public/info`;
    const r = await fetch(infoUrl);
    const d = await r.json();
    const rows = d.data?.rows || [];
    const equitySyms = rows.filter(r => {
      const s=(r.symbol||'').toUpperCase();
      return EQUITY_TICKERS.some(t=>s.includes(t)) && s.includes('PERP');
    });
    await Promise.allSettled(equitySyms.slice(0,12).map(async sym => {
      try {
        const bUrl = IS_VERCEL
          ? `${base}?path=public/orderbook&symbol=${sym.symbol}&max_level=20`
          : `${base}/public/orderbook?symbol=${sym.symbol}&max_level=20`;
        const br = await fetch(bUrl);
        if (!br.ok) return;
        const bd = await br.json();
        const book = bd.data;
        if (!book) return;
        const ticker = sym.symbol.replace(/PERP_/i,'').replace(/_USDC?/i,'');
        const bids=(book.bids||[]).map(b=>({px:+b[0],sz:+b[1]}));
        const asks=(book.asks||[]).map(a=>({px:+a[0],sz:+a[1]}));
        if (!bids.length||!asks.length) return;
        const mid=(bids[0].px+asks[0].px)/2;
        const spread=((asks[0].px-bids[0].px)/mid)*100;
        const slippages={};
        ALL_SIZES.forEach(sz=>{slippages[sz]=computeSlippage(asks,mid,sz);});
        results.push({ticker, venue:'ord', mid, spread, slippages});
      } catch(e) {}
    }));
  } catch(e) {}
  return results;
}

// ── Mock fallback ─────────────────────────────────────────────────────────────
function mockData(venue) {
  const noise = {hl:1.0, li:1.12, ord:1.07}[venue]||1;
  const assets = [
    {ticker:'AAPL',mid:213.5},{ticker:'TSLA',mid:248.2},{ticker:'NVDA',mid:875.4},
    {ticker:'AMZN',mid:196.8},{ticker:'MSFT',mid:415.6},{ticker:'GOOGL',mid:175.9},
    {ticker:'META',mid:538.2},{ticker:'SPY',mid:531.0},{ticker:'COIN',mid:228.5},{ticker:'QQQ',mid:455.3},
  ];
  return assets.map(a => {
    const mid = a.mid*(1+(Math.random()-0.5)*0.003);
    const spread = +((0.01+Math.random()*0.03)*noise).toFixed(4);
    const base = (0.002+Math.random()*0.006)*noise;
    const slippages = {};
    ALL_SIZES.forEach(sz => {
      slippages[sz] = +(base*Math.log10(sz/500+1)*(0.85+Math.random()*0.3)).toFixed(4);
    });
    return {ticker:a.ticker, venue, mid:+mid.toFixed(2), spread, slippages, simulated:true};
  });
}

// ── Render ────────────────────────────────────────────────────────────────────
const slipClass = v => !v&&v!==0?'':v<0.02?'s0':v<0.05?'s1':v<0.15?'s2':v<0.5?'s3':'s4';
const barW = v => v===null?0:Math.min(100,(v/0.8)*100);
const fmtSlip = v => v===null?'<span class="slip-na">N/A</span>':v.toFixed(3)+'%';
const fmtPrice = px => !px?'—':px>1000?'$'+px.toLocaleString('en-US',{maximumFractionDigits:2}):px>1?'$'+px.toFixed(2):'$'+px.toFixed(4);
const fmtSpread = s => s==null?'—':s.toFixed(3)+'%';
const vLabel = v => { const m={hl:'HYPERLIQUID',li:'LIGHTER',ord:'ORDERLY'},c={hl:'v-hl',li:'v-li',ord:'v-ord'}; return `<span class="venue-badge ${c[v]}">${m[v]}</span>`; };

function renderTable() {
  const sizes = [...state.activeSizes].sort((a,b)=>a-b);
  const venues = state.activeVenues;
  const thead = document.getElementById('theadRow');
  let hdr = '<th>Asset</th><th>Venue</th><th class="right">Mid Price</th><th class="right">Spread</th>';
  sizes.forEach(sz => { hdr += `<th class="right">$${sz>=1000?(sz/1000)+'K':sz} Slip</th>`; });
  thead.innerHTML = hdr;

  const tbody = document.getElementById('tbody');
  const rows = state.data.filter(d=>venues.has(d.venue));
  if (!rows.length) {
    tbody.innerHTML = `<tr class="loading-row"><td colspan="${4+sizes.length}" style="color:var(--red)">No data. Check venue status above.</td></tr>`;
    return;
  }

  const byTicker = {};
  rows.forEach(r => { (byTicker[r.ticker]=byTicker[r.ticker]||[]).push(r); });

  const best = {};
  Object.entries(byTicker).forEach(([tk,vs]) => {
    sizes.forEach(sz => {
      let bv=null, bval=Infinity;
      vs.forEach(v => { const s=v.slippages[sz]; if(s!==null&&s<bval){bval=s;bv=v.venue;} });
      best[`${tk}_${sz}`]=bv;
    });
  });

  const sorted = rows.sort((a,b)=>a.ticker<b.ticker?-1:a.ticker>b.ticker?1:a.venue.localeCompare(b.venue));
  let html='', lastTicker=null;
  sorted.forEach(row => {
    const isNew = row.ticker!==lastTicker; lastTicker=row.ticker;
    html += `<tr>`;
    html += `<td>${isNew?`<span class="ticker">${row.ticker}</span>`:''}</td>`;
    html += `<td>${vLabel(row.venue)}${row.simulated?'<span style="font-size:8px;color:var(--muted);margin-left:4px">SIM</span>':''}</td>`;
    html += `<td class="right mid-price">${fmtPrice(row.mid)}</td>`;
    html += `<td class="right spread-cell">${fmtSpread(row.spread)}</td>`;
    sizes.forEach(sz => {
      const s=row.slippages[sz];
      const isBest=best[`${row.ticker}_${sz}`]===row.venue&&s!==null;
      const cls=slipClass(s);
      html += s===null
        ? `<td class="right"><span class="slip-na">N/A</span></td>`
        : `<td class="right"><div class="slip-cell">
            <span class="slip-val ${cls}">${fmtSlip(s)}${isBest?'<span class="best-badge">BEST</span>':''}</span>
            <div class="slip-bar-wrap"><div class="slip-bar bar-${cls}" style="width:${barW(s)}%"></div></div>
           </div></td>`;
    });
    html += `</tr>`;
  });
  tbody.innerHTML = html;

  document.getElementById('summaryBar').style.display='flex';
  document.getElementById('sumAssets').textContent = Object.keys(byTicker).length;

  const vAvg={};
  rows.forEach(r=>{const s=r.slippages[10000];if(s===null)return;if(!vAvg[r.venue])vAvg[r.venue]={sum:0,n:0};vAvg[r.venue].sum+=s;vAvg[r.venue].n++;});
  let bestV='—',bestVVal=Infinity;
  Object.entries(vAvg).forEach(([v,d])=>{const avg=d.sum/d.n;if(avg<bestVVal){bestVVal=avg;bestV=v.toUpperCase();}});
  document.getElementById('sumBest').textContent=bestV;

  let deepTk='—',deepSlip=Infinity;
  rows.forEach(r=>{const s=r.slippages[50000];if(s!==null&&s<deepSlip){deepSlip=s;deepTk=`${r.ticker}/${r.venue.toUpperCase()}`;}});
  document.getElementById('sumDeepest').textContent=deepTk;
}

// ── Fetch all ─────────────────────────────────────────────────────────────────
async function fetchAll() {
  const start=Date.now();
  document.getElementById('refreshBtn').disabled=true;
  document.getElementById('liveDot').className='live-dot off';
  document.getElementById('tbody').innerHTML=`<tr class="loading-row"><td colspan="10"><span class="spinner"></span>FETCHING ORDER BOOKS…</td></tr>`;

  const setStatus=(v,cls,lbl)=>{const el=document.getElementById(`status-${v}`);if(el){el.textContent=lbl;el.className='status-tag '+cls;}};
  ['hl','li','ord'].forEach(v=>setStatus(v,'','LOADING'));
  state.simVenues.clear();
  const allData=[];

  const [hlR,liR,ordR]=await Promise.allSettled([fetchHL(),fetchLighter(),fetchOrderly()]);

  [[hlR,'hl'],[liR,'li'],[ordR,'ord']].forEach(([r,v])=>{
    if(r.status==='fulfilled'&&r.value.length){allData.push(...r.value);setStatus(v,'ok','LIVE');}
    else{const m=mockData(v);allData.push(...m);state.simVenues.add(v);setStatus(v,'sim','SIM');}
  });

  state.data=allData;
  document.getElementById('sumCycle').textContent=((Date.now()-start)/1000).toFixed(2)+'s';
  document.getElementById('ts').textContent=new Date().toLocaleTimeString();
  document.getElementById('liveDot').className='live-dot';
  document.getElementById('refreshBtn').disabled=false;
  document.getElementById('simNotice').style.display=state.simVenues.size?'block':'none';

  renderTable();
  startCountdown();
}

function startCountdown(){
  clearInterval(state.countdownHandle);
  state.countdownSec=Math.round(state.refreshInterval/1000);
  const el=document.getElementById('countdown');
  const tick=()=>{el.textContent=`NEXT ${state.countdownSec}s`;if(--state.countdownSec<0)clearInterval(state.countdownHandle);};
  tick(); state.countdownHandle=setInterval(tick,1000);
}

function startAutoRefresh(){
  clearInterval(state.intervalHandle);
  state.intervalHandle=setInterval(fetchAll,state.refreshInterval);
}

// ── Controls ──────────────────────────────────────────────────────────────────
document.querySelectorAll('[data-venue]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const v=btn.dataset.venue;
    if(state.activeVenues.has(v)&&state.activeVenues.size>1){state.activeVenues.delete(v);btn.classList.remove('on');}
    else{state.activeVenues.add(v);btn.classList.add('on');}
    renderTable();
  });
});
document.querySelectorAll('[data-size]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const sz=+btn.dataset.size;
    if(state.activeSizes.has(sz)&&state.activeSizes.size>1){state.activeSizes.delete(sz);btn.classList.remove('size-on');}
    else{state.activeSizes.add(sz);btn.classList.add('size-on');}
    renderTable();
  });
});
document.getElementById('intervalSel').addEventListener('change',e=>{state.refreshInterval=+e.target.value;startAutoRefresh();startCountdown();});
document.getElementById('refreshBtn').addEventListener('click',()=>{clearInterval(state.intervalHandle);clearInterval(state.countdownHandle);fetchAll().then(startAutoRefresh);});

fetchAll().then(startAutoRefresh);
</script>
</body>
</html>
